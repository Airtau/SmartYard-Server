request_route {
	if (is_method("INVITE") || is_method("REGISTER")) {
		route(NAT);
	}

	if (is_method("REGISTER")) {
		route(AUTH);
	}
}

route[AUTH] {
	if (!auth_check("$fd", "subscriber", "1")) {
		force_rport();
		auth_challenge("$fd", "1");
		exit;
	}
	
	force_rport();
	if (is_method("REGISTER")) {
		save("location");
		exit;
	} else {
		return;
	}
}

route[NAT] {
	if (nat_uac_test("19")) {
		if (is_method("REGISTER")) {
			set_contact_alias();
		} else {
			if(is_first_hop()) {
				set_contact_alias();
			}
		}
	}
	return;
}